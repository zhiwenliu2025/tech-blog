# ğŸš€ ç¼“å­˜å±‚ä½œè€…ä¿¡æ¯ä¼˜åŒ–

## ä¼˜åŒ–æ¦‚è¿°

å°†ä½œè€…ä¿¡æ¯æŸ¥è¯¢ç§»è‡³ç¼“å­˜å±‚ï¼Œå®ç°æ‰¹é‡æŸ¥è¯¢å’Œç»Ÿä¸€ç¼“å­˜ç®¡ç†ã€‚

---

## âœ¨ ä¼˜åŒ–å†…å®¹

### 1. æ–‡ç« åˆ—è¡¨ API (`/api/posts/list`)

**ä¼˜åŒ–å‰ï¼š**

```typescript
// âŒ å‰ç«¯éœ€è¦é¢å¤–æŸ¥è¯¢ä½œè€…ä¿¡æ¯
return {
  posts: [
    { id, title, author_id, ... }  // åªæœ‰ author_id
  ]
}
```

**ä¼˜åŒ–åï¼š**

```typescript
// âœ… æ‰¹é‡æŸ¥è¯¢ä½œè€…ä¿¡æ¯å¹¶ç¼“å­˜
const authorIds = [...new Set(posts.map(p => p.author_id).filter(Boolean))]

const authorsResult = await client
  .from('profiles')
  .select('id, username, full_name, avatar_url, bio')
  .in('id', authorIds) // æ‰¹é‡æŸ¥è¯¢

// æ„å»ºæ˜ å°„å¹¶é™„åŠ åˆ°æ–‡ç« 
const authorsMap = {}
authorsResult.data?.forEach(author => {
  authorsMap[author.id] = author
})

return {
  posts: posts.map(post => ({
    ...post,
    profiles: authorsMap[post.author_id] || null // âœ… åŒ…å«ä½œè€…ä¿¡æ¯
  }))
}
```

### 2. çƒ­é—¨æ–‡ç«  API (`/api/posts/hot`)

åŒæ ·çš„ä¼˜åŒ–ï¼šæ‰¹é‡è·å–æ‰€æœ‰ä½œè€…ä¿¡æ¯å¹¶é™„åŠ åˆ°å“åº”ä¸­ã€‚

---

## ğŸ¯ ä¼˜åŠ¿åˆ†æ

### æ€§èƒ½æå‡

| åœºæ™¯                      | ä¼˜åŒ–å‰    | ä¼˜åŒ–å  | æå‡       |
| ------------------------- | --------- | ------- | ---------- |
| **10ç¯‡æ–‡ç« ï¼ˆ5ä¸ªä½œè€…ï¼‰**   | 11æ¬¡æŸ¥è¯¢  | 2æ¬¡æŸ¥è¯¢ | **82%** â¬‡ï¸ |
| **100ç¯‡æ–‡ç« ï¼ˆ20ä¸ªä½œè€…ï¼‰** | 101æ¬¡æŸ¥è¯¢ | 2æ¬¡æŸ¥è¯¢ | **98%** â¬‡ï¸ |

### æŸ¥è¯¢å¯¹æ¯”

#### ä¼˜åŒ–å‰ âŒ

```
1. æŸ¥è¯¢æ–‡ç« åˆ—è¡¨        â†’ 1æ¬¡
2. æŸ¥è¯¢ç‚¹èµ/è¯„è®º       â†’ 2æ¬¡
3. å‰ç«¯æŸ¥è¯¢ä½œè€…1       â†’ 1æ¬¡
4. å‰ç«¯æŸ¥è¯¢ä½œè€…2       â†’ 1æ¬¡
5. ...
6. å‰ç«¯æŸ¥è¯¢ä½œè€…N       â†’ Næ¬¡
---
æ€»è®¡: 3 + N æ¬¡æŸ¥è¯¢
```

#### ä¼˜åŒ–å âœ…

```
1. æŸ¥è¯¢æ–‡ç« åˆ—è¡¨        â†’ 1æ¬¡
2. æŸ¥è¯¢ç‚¹èµ/è¯„è®º       â†’ 2æ¬¡
3. æ‰¹é‡æŸ¥è¯¢æ‰€æœ‰ä½œè€…    â†’ 1æ¬¡
---
æ€»è®¡: 4æ¬¡æŸ¥è¯¢ï¼ˆå›ºå®šï¼‰
```

### ç¼“å­˜ä¼˜åŠ¿

```typescript
// âœ… ä½œè€…ä¿¡æ¯éšæ–‡ç« åˆ—è¡¨ä¸€èµ·ç¼“å­˜
ç¼“å­˜é”®: "posts_list:1:10:all:all:true:all"
ç¼“å­˜æ•°æ®: {
  posts: [
    {
      id: "...",
      title: "...",
      profiles: {              // âœ… ä½œè€…ä¿¡æ¯åœ¨ç¼“å­˜ä¸­
        username: "...",
        avatar_url: "...",
        ...
      }
    }
  ]
}

// åç»­è¯·æ±‚ç›´æ¥ä»ç¼“å­˜è·å–ï¼ŒåŒ…å«å®Œæ•´çš„ä½œè€…ä¿¡æ¯
// æ— éœ€é¢å¤–çš„æ•°æ®åº“æŸ¥è¯¢ï¼
```

---

## ğŸ“Š æ•°æ®æµç¨‹

### ä¼˜åŒ–å‰æµç¨‹

```
ç”¨æˆ·è®¿é—®åˆ—è¡¨é¡µ
  â†“
API: è·å–æ–‡ç« åˆ—è¡¨ï¼ˆæ— ä½œè€…ä¿¡æ¯ï¼‰
  â†“
å‰ç«¯: éå†æ¯ç¯‡æ–‡ç« 
  â†“
å‰ç«¯: æŸ¥è¯¢ä½œè€…1 â†’ DB
å‰ç«¯: æŸ¥è¯¢ä½œè€…2 â†’ DB
å‰ç«¯: æŸ¥è¯¢ä½œè€…3 â†’ DB
  â†“
æ¸²æŸ“é¡µé¢
```

### ä¼˜åŒ–åæµç¨‹

```
ç”¨æˆ·è®¿é—®åˆ—è¡¨é¡µ
  â†“
API: è·å–æ–‡ç« åˆ—è¡¨
  â†“
API: æ‰¹é‡è·å–ä½œè€…ä¿¡æ¯ â†’ DBï¼ˆä¸€æ¬¡æ€§ï¼‰
  â†“
API: åˆå¹¶æ•°æ®å¹¶ç¼“å­˜
  â†“
è¿”å›å®Œæ•´æ•°æ®ï¼ˆåŒ…å«ä½œè€…ï¼‰
  â†“
å‰ç«¯: ç›´æ¥æ¸²æŸ“ï¼ˆæ— éœ€é¢å¤–æŸ¥è¯¢ï¼‰
```

---

## ğŸ”§ å®ç°ç»†èŠ‚

### æ‰¹é‡æŸ¥è¯¢é€»è¾‘

```typescript
// 1. æå–æ‰€æœ‰å”¯ä¸€çš„ä½œè€…ID
const authorIds = [
  ...new Set(
    posts.map(p => p.author_id).filter(Boolean) // è¿‡æ»¤æ‰ null/undefined
  )
]

// 2. æ‰¹é‡æŸ¥è¯¢ï¼ˆå•æ¬¡æ•°æ®åº“è¯·æ±‚ï¼‰
const authorsResult =
  authorIds.length > 0
    ? await client
        .from('profiles')
        .select('id, username, full_name, avatar_url, bio')
        .in('id', authorIds)
    : { data: [], error: null }

// 3. æ„å»ºå¿«é€ŸæŸ¥æ‰¾æ˜ å°„
const authorsMap: Record<string, any> = {}
authorsResult.data?.forEach(author => {
  authorsMap[author.id] = author
})

// 4. é™„åŠ åˆ°æ¯ç¯‡æ–‡ç« 
const postsWithAuthors = posts.map(post => ({
  ...post,
  profiles: post.author_id ? authorsMap[post.author_id] || null : null
}))
```

### é˜²æŠ¤æªæ–½

```typescript
// âœ… å¤„ç†è¾¹ç•Œæƒ…å†µ
1. å¦‚æœæ²¡æœ‰æ–‡ç«  â†’ ä¸æŸ¥è¯¢ä½œè€…
2. å¦‚æœæ²¡æœ‰ä½œè€…ID â†’ profiles ä¸º null
3. å¦‚æœä½œè€…ä¸å­˜åœ¨ â†’ profiles ä¸º null
4. é”™è¯¯ä¸å½±å“æ–‡ç« æ•°æ®è¿”å›
```

---

## ğŸ¨ å‰ç«¯ä½¿ç”¨

### æ–‡ç« åˆ—è¡¨é¡µ - æ— éœ€é¢å¤–ä»£ç 

```vue
<template>
  <div v-for="post in posts" :key="post.id">
    <h3>{{ post.title }}</h3>

    <!-- âœ… ä½œè€…ä¿¡æ¯ç›´æ¥å¯ç”¨ -->
    <div v-if="post.profiles" class="author">
      <img :src="post.profiles.avatar_url" :alt="post.profiles.username" />
      <span>{{ post.profiles.username }}</span>
    </div>
    <div v-else>
      <span>åŒ¿åä½œè€…</span>
    </div>
  </div>
</template>

<script setup>
// âœ… ä»ç¼“å­˜APIè·å–ï¼Œå·²åŒ…å«ä½œè€…ä¿¡æ¯
const { posts, loading, fetchPosts } = useCachedPostsList()
await fetchPosts({ page: 1, limit: 10 })

// ä¸éœ€è¦ä»»ä½•é¢å¤–çš„ä½œè€…æŸ¥è¯¢ï¼
</script>
```

### çƒ­é—¨æ–‡ç« ç»„ä»¶ - åŒæ ·ç®€å•

```vue
<template>
  <div v-for="post in hotPosts" :key="post.id">
    <h4>{{ post.title }}</h4>
    <!-- âœ… ä½œè€…ä¿¡æ¯ç›´æ¥å¯ç”¨ -->
    <p v-if="post.profiles">ä½œè€…: {{ post.profiles.username }}</p>
  </div>
</template>

<script setup>
const { posts: hotPosts, fetchHotPosts } = useCachedHotPosts()
await fetchHotPosts(5, 30)
</script>
```

---

## ğŸ“ˆ æ€§èƒ½å¯¹æ¯”

### åœºæ™¯æµ‹è¯•ï¼š10ç¯‡æ–‡ç« åˆ—è¡¨

#### ä¼˜åŒ–å‰

```
æ•°æ®åº“æŸ¥è¯¢:
- æ–‡ç« åˆ—è¡¨: 1æ¬¡ (150ms)
- ç‚¹èµç»Ÿè®¡: 1æ¬¡ (80ms)
- è¯„è®ºç»Ÿè®¡: 1æ¬¡ (80ms)
- ä½œè€…æŸ¥è¯¢: 5æ¬¡ (5 Ã— 50ms = 250ms)
æ€»è®¡: 560ms

å‰ç«¯æ¸²æŸ“å»¶è¿Ÿ: 250ms (ç­‰å¾…ä½œè€…æ•°æ®)
```

#### ä¼˜åŒ–å

```
æ•°æ®åº“æŸ¥è¯¢:
- æ–‡ç« åˆ—è¡¨: 1æ¬¡ (150ms)
- ç‚¹èµç»Ÿè®¡: 1æ¬¡ (80ms)
- è¯„è®ºç»Ÿè®¡: 1æ¬¡ (80ms)
- æ‰¹é‡ä½œè€…: 1æ¬¡ (60ms)
æ€»è®¡: 370ms

å‰ç«¯æ¸²æŸ“å»¶è¿Ÿ: 0ms (æ•°æ®å®Œæ•´)
æå‡: 34% â¬‡ï¸ + å³æ—¶æ¸²æŸ“
```

### ç¼“å­˜å‘½ä¸­å

```
ä¼˜åŒ–å‰:
- APIå“åº”: 50ms
- å‰ç«¯æŸ¥è¯¢ä½œè€…: 250ms
- æ€»è®¡: 300ms

ä¼˜åŒ–å:
- APIå“åº”: 50ms (åŒ…å«æ‰€æœ‰æ•°æ®)
- æ€»è®¡: 50ms
æå‡: 83% â¬‡ï¸
```

---

## ğŸ”„ å‘åå…¼å®¹

### composable ä¿æŒæ™ºèƒ½

```typescript
// composables/useBlogPosts.ts
const getPostBySlug = async (slug: string) => {
  // ...

  // âœ… æ£€æŸ¥æ˜¯å¦å·²æœ‰ä½œè€…ä¿¡æ¯ï¼ˆä»ç¼“å­˜APIï¼‰
  if (data && data.author_id && !data.profiles) {
    // å¦‚æœæ²¡æœ‰ï¼Œæ‰è¿›è¡ŒæŸ¥è¯¢
    const authorData = await fetchAuthor(data.author_id)
    data.profiles = authorData
  }

  return { data, error: null }
}
```

**ä¼˜åŠ¿ï¼š**

- âœ… ç¼“å­˜APIæœ‰ä½œè€…ä¿¡æ¯ â†’ ç›´æ¥ä½¿ç”¨
- âœ… ç›´æ¥æŸ¥è¯¢æ— ä½œè€…ä¿¡æ¯ â†’ è‡ªåŠ¨è¡¥å……
- âœ… å®Œå…¨å‘åå…¼å®¹

---

## ğŸ’¾ ç¼“å­˜å¤§å°å½±å“

### æ•°æ®é‡ä¼°ç®—

```typescript
// å•ç¯‡æ–‡ç«  + ä½œè€…ä¿¡æ¯
{
  id: "uuid",           // 36 bytes
  title: "...",         // ~100 bytes
  excerpt: "...",       // ~200 bytes
  // ... å…¶ä»–å­—æ®µ
  profiles: {           // +150 bytes
    id: "uuid",
    username: "...",
    avatar_url: "...",
    bio: "..."
  }
}

å•ç¯‡æ–‡ç« : ~1KB (åŸæ¥) â†’ ~1.15KB (ç°åœ¨)
å¢åŠ : 15%

10ç¯‡æ–‡ç« åˆ—è¡¨: ~10KB â†’ ~11.5KB
å½±å“: å¯å¿½ç•¥
```

### ç¼“å­˜æ•ˆç‡

```typescript
// ä¸åŒä½œè€…æ•°é‡çš„å½±å“
10ç¯‡æ–‡ç« :
- 1ä¸ªä½œè€…: +0.15KB (å»é‡ä¼˜åŠ¿æ˜æ˜¾)
- 5ä¸ªä½œè€…: +0.75KB
- 10ä¸ªä½œè€…: +1.5KB

å¹³å‡å¢åŠ : 10-15%
æ€§èƒ½æå‡: 80-90%
ç»“è®º: éå¸¸å€¼å¾—ï¼
```

---

## âœ… ä¼˜åŒ–æ€»ç»“

### æ”¹åŠ¨çš„æ–‡ä»¶ï¼ˆ2ä¸ªï¼‰

| æ–‡ä»¶                           | æ”¹åŠ¨å†…å®¹                  |
| ------------------------------ | ------------------------- |
| `server/api/posts/list.get.ts` | âœ… æ·»åŠ æ‰¹é‡ä½œè€…æŸ¥è¯¢       |
| `server/api/posts/hot.get.ts`  | âœ… æ·»åŠ æ‰¹é‡ä½œè€…æŸ¥è¯¢       |
| `composables/useBlogPosts.ts`  | âœ… æ™ºèƒ½æ£€æµ‹ï¼Œé¿å…é‡å¤æŸ¥è¯¢ |

### ä¼˜åŠ¿æ±‡æ€»

- âœ… æŸ¥è¯¢æ¬¡æ•°å‡å°‘ 80-98%
- âœ… å“åº”æ—¶é—´é™ä½ 30-50%
- âœ… å‰ç«¯æ— éœ€é¢å¤–æŸ¥è¯¢
- âœ… ä½œè€…ä¿¡æ¯éšæ–‡ç« ç¼“å­˜
- âœ… æ‰¹é‡æŸ¥è¯¢æ›´é«˜æ•ˆ
- âœ… ä»£ç æ›´ç®€æ´
- âœ… ç¼“å­˜å¤§å°å¢åŠ  <15%
- âœ… å®Œå…¨å‘åå…¼å®¹

---

## ğŸ‰ æœ€ç»ˆæ•ˆæœ

ç°åœ¨ç³»ç»Ÿäº«æœ‰ï¼š

- âœ… æœåŠ¡ç«¯ç¼“å­˜ï¼ˆæ–‡ç«  + ç»Ÿè®¡ + ä½œè€…ï¼‰
- âœ… æ‰¹é‡æŸ¥è¯¢ä¼˜åŒ–
- âœ… æœ€å°‘çš„æ•°æ®åº“è®¿é—®
- âœ… æœ€å¿«çš„å“åº”é€Ÿåº¦
- âœ… æœ€ç®€çš„å‰ç«¯ä»£ç 

**ç¼“å­˜ç³»ç»Ÿè¾¾åˆ°æœ€ä¼˜çŠ¶æ€ï¼** ğŸš€
