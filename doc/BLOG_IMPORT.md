# åšå®¢å¯¼å…¥åŠŸèƒ½æ–¹æ¡ˆæ–‡æ¡£

## æ¦‚è¿°

åšå®¢å¯¼å…¥åŠŸèƒ½å…è®¸ç”¨æˆ·é€šè¿‡è¾“å…¥å…¶ä»–æŠ€æœ¯åšå®¢ç½‘ç«™çš„æ–‡ç«  URLï¼Œå°†æ–‡ç« å†…å®¹ï¼ˆæ–‡å­—ã€å›¾ç‰‡ã€ä»£ç å—ç­‰ï¼‰å¯¼å…¥åˆ°æœ¬ç³»ç»Ÿä¸­ã€‚ç³»ç»Ÿä½¿ç”¨é€šç”¨æ­£æ–‡æå–ç®—æ³•ï¼Œæ”¯æŒç»å¤§å¤šæ•°åšå®¢ç½‘ç«™ï¼Œå¹¶æä¾›ä¸»æµå¹³å°ä¸“ç”¨é€‚é…å™¨ä»¥è·å–æ›´ä¸°å¯Œçš„å…ƒæ•°æ®ã€‚

### æ ¸å¿ƒç›®æ ‡

- **æœ€å¤§åŒ–å†…å®¹ä¿ç•™**ï¼šå®Œæ•´å¯¼å…¥æ–‡å­—ã€å›¾ç‰‡ã€ä»£ç å—ã€æ ¼å¼ç­‰ä¿¡æ¯
- **å›¾ç‰‡æœ¬åœ°åŒ–**ï¼šå°†å¤–ç«™å›¾ç‰‡ä¸‹è½½å¹¶å­˜å‚¨åˆ° Supabase Storageï¼Œé¿å…å¤–é“¾å¤±æ•ˆ
- **é€šç”¨æ€§å¼º**ï¼šåŸºäº Readability ç®—æ³•ï¼Œæ— éœ€é’ˆå¯¹æ¯ä¸ªç½‘ç«™å•ç‹¬é€‚é…
- **å®‰å…¨å¯é **ï¼šé˜² XSSã€é˜² SSRFã€é¢‘ç‡é™åˆ¶

## é¡¹ç›®ç°çŠ¶

| é¡¹ç›®ç‰¹å¾ | å½“å‰å®ç°                                             |
| -------- | ---------------------------------------------------- |
| å†…å®¹å­˜å‚¨ | Supabase PostgreSQLï¼ˆ`blog_posts` è¡¨ï¼‰               |
| å†…å®¹æ ¼å¼ | Markdown æ–‡æœ¬                                        |
| å›¾ç‰‡å­˜å‚¨ | Supabase Storageï¼ˆ`blog-images` bucketï¼‰             |
| ç¼–è¾‘å™¨   | TipTapï¼ˆWYSIWYG + Markdownï¼‰                         |
| å·²æœ‰å·¥å…· | `turndown`ï¼ˆHTMLâ†’Markdownï¼‰ã€`dompurify`ï¼ˆXSS æ¸…ç†ï¼‰ |
| å¯¼å…¥åŠŸèƒ½ | æ—                                                    |

**å…³é”®ä¼˜åŠ¿**ï¼šé¡¹ç›®å·²ä¾èµ– `turndown` å’Œ `dompurify`ï¼Œè¿™ä¸¤ä¸ªåº“æ˜¯å¯¼å…¥åŠŸèƒ½çš„æ ¸å¿ƒä¾èµ–ï¼Œä¸éœ€è¦é¢å¤–å¼•å…¥ã€‚

## æ¶æ„è®¾è®¡

### æ•´ä½“æµç¨‹

```
ç”¨æˆ·è¾“å…¥ URL
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å‰ç«¯ - å¯¼å…¥ç•Œé¢         â”‚
â”‚  (URL è¾“å…¥ + é¢„è§ˆ + ç¼–è¾‘) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ POST /api/import/fetch
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æœåŠ¡ç«¯ - å†…å®¹æŠ“å–       â”‚
â”‚  1. è¯·æ±‚ç›®æ ‡é¡µé¢ HTML     â”‚
â”‚  2. æå–æ­£æ–‡å†…å®¹          â”‚
â”‚  3. ä¸‹è½½å¹¶ä¸Šä¼ å›¾ç‰‡        â”‚
â”‚  4. HTML â†’ Markdown è½¬æ¢  â”‚
â”‚  5. è¿”å›ç»“æ„åŒ–æ•°æ®        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ è¿”å›é¢„è§ˆæ•°æ®
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å‰ç«¯ - é¢„è§ˆä¸ç¼–è¾‘       â”‚
â”‚  ç”¨æˆ·ç¡®è®¤åä¿å­˜åˆ°æ•°æ®åº“    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ savePost()
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Supabase                â”‚
â”‚  blog_posts + blog-imagesâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å†…å®¹æå–ç®¡çº¿

```
åŸå§‹ HTML
    â”‚
    â–¼
DOMPurify æ¸…ç†æ¶æ„å†…å®¹
    â”‚
    â–¼
JSDOM è§£æä¸º DOM æ ‘
    â”‚
    â–¼
Readability æå–æ­£æ–‡ + å…ƒæ•°æ®
    â”‚
    â–¼
Turndown å°†æ­£æ–‡ HTML â†’ Markdown
    â”‚
    â–¼
å›¾ç‰‡å¤„ç†ï¼ˆä¸‹è½½ â†’ ä¸Šä¼  Supabase â†’ URL æ›¿æ¢ï¼‰
    â”‚
    â–¼
æ¥æºæ ‡æ³¨è¿½åŠ 
    â”‚
    â–¼
è¿”å›ç»“æ„åŒ–æ•°æ®
```

## æ¨¡å—è®¾è®¡

### æ¨¡å— 1ï¼šæœåŠ¡ç«¯ API â€” å†…å®¹æŠ“å–ä¸è§£æ

**æ–‡ä»¶**ï¼š`server/api/import/fetch.post.ts`

#### èŒè´£

1. æ¥æ”¶ç”¨æˆ·æäº¤çš„ URLï¼Œæ ¡éªŒåˆæ³•æ€§
2. é€šè¿‡ HTTP è¯·æ±‚è·å–é¡µé¢ HTML
3. ä½¿ç”¨ Readability æå–æ­£æ–‡ï¼ˆæˆ–åŒ¹é…ä¸“ç”¨é€‚é…å™¨ï¼‰
4. æå–å…ƒæ•°æ®ï¼ˆæ ‡é¢˜ã€ä½œè€…ã€å‘å¸ƒæ—¶é—´ã€å°é¢å›¾ã€æ ‡ç­¾ç­‰ï¼‰
5. å°†æ­£æ–‡ HTML è½¬ä¸º Markdownï¼ˆä½¿ç”¨ `turndown`ï¼‰
6. å¤„ç†æ–‡ç« ä¸­çš„å›¾ç‰‡ï¼ˆä¸‹è½½ â†’ ä¸Šä¼ åˆ° Supabase Storage â†’ æ›¿æ¢ URLï¼‰
7. è¿”å›ç»“æ„åŒ–çš„å¯¼å…¥æ•°æ®

#### è¯·æ±‚å‚æ•°

```typescript
interface ImportRequest {
  url: string // ç›®æ ‡æ–‡ç«  URL
}
```

#### è¿”å›æ•°æ®ç»“æ„

```typescript
interface ImportResult {
  title: string // æ–‡ç« æ ‡é¢˜
  content: string // Markdown æ ¼å¼æ­£æ–‡
  excerpt: string // è‡ªåŠ¨æå–çš„æ‘˜è¦ï¼ˆå‰ 200 å­—ï¼‰
  coverImage: string | null // å°é¢å›¾ï¼ˆä¸Šä¼ åçš„ Supabase URLï¼‰
  sourceUrl: string // åŸæ–‡é“¾æ¥
  sourceSiteName: string // æ¥æºç½‘ç«™åï¼ˆå¦‚ "CSDN"ã€"æ˜é‡‘"ï¼‰
  author: string | null // åŸä½œè€…
  publishedAt: string | null // åŸå‘å¸ƒæ—¶é—´
  tags: string[] // ä»é¡µé¢æå–çš„æ ‡ç­¾
  images: {
    // å›¾ç‰‡å¤„ç†æŠ¥å‘Š
    total: number // å›¾ç‰‡æ€»æ•°
    success: number // æˆåŠŸä¸‹è½½å¹¶ä¸Šä¼ çš„æ•°é‡
    failed: string[] // ä¸‹è½½å¤±è´¥çš„åŸå§‹ URL
  }
}
```

#### URL éªŒè¯è§„åˆ™

```typescript
function validateUrl(url: string): boolean {
  // 1. å¿…é¡»æ˜¯åˆæ³• URL
  // 2. å¿…é¡»æ˜¯ http æˆ– https åè®®
  // 3. ç¦æ­¢å†…ç½‘åœ°å€ï¼ˆé˜² SSRFï¼‰ï¼š
  //    - localhost, 127.0.0.1
  //    - 10.x.x.x, 172.16-31.x.x, 192.168.x.x
  //    - 169.254.x.xï¼ˆlink-localï¼‰
  // 4. ç¦æ­¢éæ ‡å‡†ç«¯å£ï¼ˆå¯é€‰ï¼‰
}
```

### æ¨¡å— 2ï¼šå›¾ç‰‡å¤„ç†å·¥å…·

**æ–‡ä»¶**ï¼š`server/utils/import-utils.ts`

#### å›¾ç‰‡ä¸‹è½½ä¸ä¸Šä¼ æµç¨‹

```
1. ä» Markdown ä¸­æ­£åˆ™æå–å›¾ç‰‡ URLï¼š  /!\[([^\]]*)\]\(([^)]+)\)/g
2. è¿‡æ»¤å·²æ˜¯ Supabase URL çš„å›¾ç‰‡ï¼ˆé¿å…é‡å¤å¤„ç†ï¼‰
3. å¹¶å‘ä¸‹è½½å›¾ç‰‡ï¼ˆé™åˆ¶å¹¶å‘æ•° 3ï¼‰
   - è®¾ç½® Referer å¤´ä¸ºæºç«™åŸŸåï¼ˆç»•è¿‡é˜²ç›—é“¾ï¼‰
   - è®¾ç½® User-Agent ä¸ºæµè§ˆå™¨æ ‡è¯†
   - è¶…æ—¶ 15 ç§’
4. æ ¡éªŒä¸‹è½½å†…å®¹ï¼ˆContent-Type å¿…é¡»æ˜¯ image/*ï¼‰
5. ä¸Šä¼ åˆ° Supabase Storageï¼šblog-images/{user_id}/imported/{timestamp}-{random}.{ext}
6. æ›¿æ¢ Markdown ä¸­çš„å›¾ç‰‡ URL
7. ä¸‹è½½å¤±è´¥çš„ä¿ç•™åŸå§‹ URL ä½œä¸º fallback
```

#### æ ¸å¿ƒå‡½æ•°

```typescript
// ä¸‹è½½å¹¶ä¸Šä¼ å•å¼ å›¾ç‰‡
async function processImage(
  imageUrl: string,
  sourceHost: string,
  userId: string,
  supabase: SupabaseClient
): Promise<{ success: boolean; newUrl?: string; error?: string }>

// æ‰¹é‡å¤„ç†æ–‡ç« ä¸­æ‰€æœ‰å›¾ç‰‡
async function processAllImages(
  markdown: string,
  sourceUrl: string,
  userId: string,
  supabase: SupabaseClient
): Promise<{ content: string; report: ImageReport }>
```

### æ¨¡å— 3ï¼šå¹³å°é€‚é…å™¨

**ç›®å½•**ï¼š`server/utils/import-adapters/`

#### é€‚é…å™¨æ¥å£

```typescript
interface ImportAdapter {
  /** åˆ¤æ–­æ˜¯å¦åŒ¹é…æ­¤é€‚é…å™¨ */
  match(url: string): boolean

  /** æå–æ–‡ç« å†…å®¹ï¼Œè¿”å›æ¯”é€šç”¨æ–¹æ¡ˆæ›´ä¸°å¯Œçš„ä¿¡æ¯ */
  extract(html: string, url: string): Promise<ExtractResult>
}

interface ExtractResult {
  title: string
  content: string // HTML æ ¼å¼æ­£æ–‡
  author?: string
  publishedAt?: string
  tags?: string[]
  coverImage?: string
  siteName: string
}
```

#### é€‚é…å™¨æ³¨å†Œ

**æ–‡ä»¶**ï¼š`server/utils/import-adapters/index.ts`

```typescript
import { BaseAdapter } from './base'
import { CSDNAdapter } from './csdn'
import { JuejinAdapter } from './juejin'
// ...

const adapters: ImportAdapter[] = [
  new CSDNAdapter(),
  new JuejinAdapter()
  // æ›´å¤šé€‚é…å™¨...
]

/** æ ¹æ® URL é€‰æ‹©æœ€ä½³é€‚é…å™¨ï¼Œæ— åŒ¹é…åˆ™è¿”å›é€šç”¨é€‚é…å™¨ */
export function getAdapter(url: string): ImportAdapter {
  return adapters.find(a => a.match(url)) ?? new BaseAdapter()
}
```

#### é€šç”¨é€‚é…å™¨ï¼ˆå…œåº•æ–¹æ¡ˆï¼‰

**æ–‡ä»¶**ï¼š`server/utils/import-adapters/base.ts`

ä½¿ç”¨ `@mozilla/readability` + `jsdom` å®ç°ï¼Œèƒ½é€‚é…ç»å¤§å¤šæ•°ç½‘ç«™ï¼š

```typescript
import { Readability } from '@mozilla/readability'
import { JSDOM } from 'jsdom'

class BaseAdapter implements ImportAdapter {
  match(_url: string) {
    return true
  } // å§‹ç»ˆåŒ¹é…ï¼Œä½œä¸ºå…œåº•

  async extract(html: string, url: string): Promise<ExtractResult> {
    const dom = new JSDOM(html, { url })
    const reader = new Readability(dom.window.document)
    const article = reader.parse()

    return {
      title: article?.title ?? '',
      content: article?.content ?? '',
      author: article?.byline ?? undefined,
      siteName: article?.siteName ?? new URL(url).hostname
      // ...
    }
  }
}
```

#### ä¸»æµå¹³å°é€‚é…å™¨

| å¹³å°     | æ–‡ä»¶         | URL åŒ¹é…è§„åˆ™                 | ç‰¹æ®Šå¤„ç†                                                                              |
| -------- | ------------ | ---------------------------- | ------------------------------------------------------------------------------------- |
| CSDN     | `csdn.ts`    | `blog.csdn.net`              | æå– `#article_content` divï¼›ç§»é™¤å¹¿å‘Šå’Œæ¨èåŒºåŸŸ                                       |
| æ˜é‡‘     | `juejin.ts`  | `juejin.cn/post/`            | é€šè¿‡å†…éƒ¨ API `https://api.juejin.cn/content_api/v1/article/detail` è·å– Markdown åŸæ–‡ |
| çŸ¥ä¹ä¸“æ  | `zhihu.ts`   | `zhuanlan.zhihu.com`         | æå– `.Post-RichText` åŒºåŸŸï¼›å¤„ç†æ‡’åŠ è½½å›¾ç‰‡ `data-original` å±æ€§                       |
| Medium   | `medium.ts`  | `medium.com`, `*.medium.com` | æå– `<article>` æ ‡ç­¾ï¼›å¤„ç†ä»˜è´¹å¢™å†…å®¹æç¤º                                             |
| åšå®¢å›­   | `cnblogs.ts` | `cnblogs.com`                | æå– `#cnblogs_post_body` div                                                         |
| ç®€ä¹¦     | `jianshu.ts` | `jianshu.com/p/`             | æå– `.article` åŒºåŸŸ                                                                  |

### æ¨¡å— 4ï¼šå‰ç«¯å¯¼å…¥é¡µé¢

**æ–‡ä»¶**ï¼š`pages/admin/import.vue`

#### ç•Œé¢è®¾è®¡

**ä¸‰æ­¥å¼æ“ä½œæµç¨‹**ï¼š

##### Step 1 â€” URL è¾“å…¥

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“¥ å¯¼å…¥æ–‡ç«                               â”‚
â”‚                                          â”‚
â”‚  è¯·è¾“å…¥æ–‡ç«  URLï¼š                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ https://blog.csdn.net/... â”‚ â”‚ è§£æ â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                          â”‚
â”‚  æ”¯æŒ CSDNã€æ˜é‡‘ã€çŸ¥ä¹ã€Mediumã€åšå®¢å›­ç­‰   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

##### Step 2 â€” é¢„è§ˆä¸ç¼–è¾‘

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âœ… è§£ææˆåŠŸ       æ¥æºï¼šCSDN             â”‚
â”‚                                          â”‚
â”‚  æ ‡é¢˜ï¼šâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚        â”‚ Vue3 ç»„åˆå¼ API æ·±å…¥è§£æ      â”‚   â”‚
â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  åˆ†ç±»ï¼šâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  æ ‡ç­¾ï¼šâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚        â”‚ å‰ç«¯å¼€å‘ â–¼â”‚       â”‚ Vue3, JS â”‚  â”‚
â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  æ‘˜è¦ï¼šâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚        â”‚ æœ¬æ–‡æ·±å…¥ä»‹ç» Vue3 ç»„åˆå¼...   â”‚   â”‚
â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                          â”‚
â”‚  ğŸ“· å›¾ç‰‡å¯¼å…¥ï¼š5 å¼ æˆåŠŸ / 1 å¼ å¤±è´¥         â”‚
â”‚     å¤±è´¥å›¾ç‰‡ï¼šhttps://xxx.com/img.png    â”‚
â”‚                                          â”‚
â”‚  â”€â”€ æ­£æ–‡é¢„è§ˆ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  â”‚ Vue3 ç»„åˆå¼ API æ·±å…¥è§£æ              â”‚  â”‚
â”‚  â”‚                                      â”‚  â”‚
â”‚  â”‚ ## å‰è¨€                              â”‚  â”‚
â”‚  â”‚ Vue3 å¼•å…¥äº†ç»„åˆå¼ APIï¼Œè¿™æ˜¯ä¸€ç§...    â”‚  â”‚
â”‚  â”‚ ...                                  â”‚  â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ä¿å­˜ä¸ºè‰ç¨¿ ğŸ“ â”‚  â”‚ åœ¨ç¼–è¾‘å™¨ä¸­ç¼–è¾‘ âœï¸â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

##### Step 3 â€” ä¿å­˜ç¡®è®¤

- è°ƒç”¨ç°æœ‰çš„ `useBlogPosts().savePost()` ä¿å­˜åˆ°æ•°æ®åº“
- æˆåŠŸåæç¤ºå¹¶è·³è½¬åˆ°æ–‡ç« é¡µé¢æˆ–ç¼–è¾‘å™¨

### æ¨¡å— 5ï¼šå‰ç«¯ Composable

**æ–‡ä»¶**ï¼š`composables/useImport.ts`

```typescript
export function useImport() {
  const loading = ref(false)
  const result = ref<ImportResult | null>(null)
  const error = ref<string | null>(null)
  const step = ref<'input' | 'preview' | 'saving'>('input')

  /**
   * è§£æè¿œç¨‹æ–‡ç« 
   * @param url ç›®æ ‡æ–‡ç«  URL
   */
  async function fetchArticle(url: string): Promise<void> {
    loading.value = true
    error.value = null
    try {
      const data = await $fetch('/api/import/fetch', {
        method: 'POST',
        body: { url }
      })
      result.value = data
      step.value = 'preview'
    } catch (e) {
      error.value = e.message || 'è§£æå¤±è´¥ï¼Œè¯·æ£€æŸ¥ URL æ˜¯å¦æ­£ç¡®'
    } finally {
      loading.value = false
    }
  }

  /**
   * å°†å¯¼å…¥æ•°æ®ä¿å­˜ä¸ºåšå®¢æ–‡ç« 
   */
  async function saveAsPost(options: {
    title: string
    content: string
    excerpt: string
    category: string
    tags: string[]
    coverImage: string | null
    published: boolean
  }): Promise<string> {
    // è°ƒç”¨ç°æœ‰çš„ savePost é€»è¾‘
    // è¿”å›æ–°æ–‡ç« çš„ slug
  }

  function reset() {
    result.value = null
    error.value = null
    step.value = 'input'
  }

  return { loading, result, error, step, fetchArticle, saveAsPost, reset }
}
```

### æ¨¡å— 6ï¼šæ¥æºæ ‡æ³¨

è‡ªåŠ¨åœ¨å¯¼å…¥æ–‡ç« çš„ Markdown æœ«å°¾è¿½åŠ æ¥æºä¿¡æ¯ï¼š

```markdown
---

> ğŸ“Œ æœ¬æ–‡è½¬è½½è‡ª [åŸæ–‡æ ‡é¢˜](åŸæ–‡é“¾æ¥)
> åŸä½œè€…ï¼šxxx | å¯¼å…¥æ—¶é—´ï¼š2026-02-09
```

åŒæ—¶åœ¨ `blog_posts` è¡¨ä¸­å¯é€šè¿‡æ‘˜è¦æˆ–è‡ªå®šä¹‰å­—æ®µè®°å½•æ¥æº URLï¼Œä¾¿äºæº¯æºã€‚

## æŠ€æœ¯éš¾ç‚¹ä¸è§£å†³æ–¹æ¡ˆ

| éš¾ç‚¹                       | è§£å†³æ–¹æ¡ˆ                                                                                |
| -------------------------- | --------------------------------------------------------------------------------------- |
| **é˜²ç›—é“¾å›¾ç‰‡**             | æœåŠ¡ç«¯ä¸‹è½½æ—¶è®¾ç½® `Referer` ä¸ºæºç«™åŸŸåï¼›å¤±è´¥æ—¶å°è¯•å»æ‰ Referer é‡è¯•                      |
| **SPA æ¸²æŸ“é¡µé¢**ï¼ˆå¦‚æ˜é‡‘ï¼‰ | æ˜é‡‘ç­‰å¹³å°é€šè¿‡å†…éƒ¨ API ç›´æ¥è·å–æ–‡ç«  JSON/Markdown æ•°æ®ï¼Œæ— éœ€æ¸²æŸ“ JS                     |
| **åçˆ¬é™åˆ¶**               | è®¾ç½®åˆç†çš„ User-Agentï¼ˆæ¨¡æ‹Ÿæµè§ˆå™¨ï¼‰ï¼›æ·»åŠ è¯·æ±‚å»¶è¿Ÿï¼›é™åˆ¶ç”¨æˆ·å¯¼å…¥é¢‘ç‡                     |
| **å†…å®¹æ ¼å¼æ··ä¹±**           | Readability æå–æ­£æ–‡ â†’ DOMPurify æ¸…ç† â†’ Turndown è½¬ Markdownï¼Œä¸‰å±‚å¤„ç†                  |
| **ä»£ç å—ä¸¢å¤±æ ¼å¼**         | è‡ªå®šä¹‰ Turndown è§„åˆ™ï¼šä¿ç•™ `<pre><code>` æ ‡ç­¾ï¼Œæ­£ç¡®è¯†åˆ«è¯­è¨€ç±»å‹ï¼ˆclass="language-xxx"ï¼‰ |
| **æ•°å­¦å…¬å¼ï¼ˆLaTeXï¼‰**      | è‡ªå®šä¹‰ Turndown è§„åˆ™ï¼šä¿ç•™ `$...$` å’Œ `$$...$$` å†…å®¹ä¸è½¬æ¢                              |
| **å›¾ç‰‡ä¸‹è½½å¤±è´¥**           | ä¿ç•™åŸå§‹ URL ä½œä¸º fallbackï¼Œåœ¨å¯¼å…¥æŠ¥å‘Šä¸­æç¤ºç”¨æˆ·æ‰‹åŠ¨å¤„ç†                                |
| **å¤§æ–‡ç«  / å¤šå›¾ç‰‡**        | å›¾ç‰‡å¹¶å‘ä¸‹è½½ï¼ˆé™åˆ¶å¹¶å‘æ•° 3ï¼‰ï¼Œå•å¼ è¶…æ—¶ 15 ç§’ï¼Œæ€»è¶…æ—¶ 60 ç§’                              |
| **æ‡’åŠ è½½å›¾ç‰‡**             | æ£€æŸ¥ `data-src`ã€`data-original`ã€`data-lazy-src` ç­‰å¸¸è§æ‡’åŠ è½½å±æ€§                      |
| **ç›¸å¯¹è·¯å¾„å›¾ç‰‡**           | å°†ç›¸å¯¹è·¯å¾„æ‹¼æ¥æºç«™åŸŸåè½¬ä¸ºç»å¯¹è·¯å¾„                                                      |

## å®‰å…¨è®¾è®¡

### XSS é˜²æŠ¤

- æ‰€æœ‰å¯¼å…¥çš„ HTML ç» `DOMPurify` æ¸…ç†åå†è½¬æ¢ä¸º Markdown
- ç§»é™¤æ‰€æœ‰ `<script>`ã€`<iframe>`ã€`<object>` ç­‰å±é™©æ ‡ç­¾
- ç§»é™¤å†…è”äº‹ä»¶å¤„ç†å™¨ï¼ˆ`onclick`ã€`onerror` ç­‰ï¼‰

### SSRF é˜²æŠ¤

æœåŠ¡ç«¯éªŒè¯ URLï¼Œç¦æ­¢è®¿é—®ä»¥ä¸‹åœ°å€ï¼š

```typescript
const BLOCKED_HOSTS = ['localhost', '127.0.0.1', '0.0.0.0', '::1']

const BLOCKED_RANGES = [
  /^10\./, // 10.0.0.0/8
  /^172\.(1[6-9]|2\d|3[01])\./, // 172.16.0.0/12
  /^192\.168\./, // 192.168.0.0/16
  /^169\.254\./ // link-local
]
```

### èµ„æºé™åˆ¶

| é™åˆ¶é¡¹       | æ•°å€¼            | è¯´æ˜                       |
| ------------ | --------------- | -------------------------- |
| æ–‡ç« å†…å®¹å¤§å° | 1 MB            | å•ç¯‡æ–‡ç«  Markdown æœ€å¤§ä½“ç§¯ |
| å•å¼ å›¾ç‰‡å¤§å° | 10 MB           | è¶…è¿‡åˆ™è·³è¿‡å¹¶æŠ¥å‘Š           |
| å›¾ç‰‡æ€»å¤§å°   | 50 MB           | å•æ¬¡å¯¼å…¥æ‰€æœ‰å›¾ç‰‡ç´¯è®¡       |
| å¯¼å…¥é¢‘ç‡     | 10 æ¬¡/å°æ—¶/ç”¨æˆ· | é˜²æ­¢æ»¥ç”¨                   |
| è¯·æ±‚è¶…æ—¶     | 30 ç§’           | é¡µé¢æŠ“å–è¶…æ—¶               |
| å›¾ç‰‡ä¸‹è½½è¶…æ—¶ | 15 ç§’/å¼         | å•å¼ å›¾ç‰‡ä¸‹è½½è¶…æ—¶           |

### æƒé™éªŒè¯

- ä»…ç™»å½•ç”¨æˆ·å¯ä½¿ç”¨å¯¼å…¥åŠŸèƒ½
- æœåŠ¡ç«¯é€šè¿‡ Supabase Auth éªŒè¯ç”¨æˆ·èº«ä»½
- å¯¼å…¥çš„æ–‡ç«  `author_id` è®¾ä¸ºå½“å‰ç”¨æˆ·

## æ–°å¢ä¾èµ–

| åŒ…å                   | ç‰ˆæœ¬   | ç”¨é€”                                         | å®‰è£…ä½ç½®        |
| ---------------------- | ------ | -------------------------------------------- | --------------- |
| `@mozilla/readability` | latest | Mozilla æ­£æ–‡æå–ç®—æ³•ï¼ˆFirefox é˜…è¯»æ¨¡å¼åŒæ¬¾ï¼‰ | dependencies    |
| `jsdom`                | latest | Node.js ç«¯ HTML DOM è§£æï¼Œé…åˆ Readability   | dependencies    |
| `@types/jsdom`         | latest | jsdom ç±»å‹å®šä¹‰                               | devDependencies |

> **å·²æœ‰ä¾èµ–ï¼ˆæ— éœ€æ–°å¢ï¼‰**ï¼š`turndown`ï¼ˆHTMLâ†’Markdownï¼‰ã€`dompurify`ï¼ˆXSS æ¸…ç†ï¼‰

## æ–°å¢æ–‡ä»¶æ¸…å•

```
server/
â”œâ”€â”€ api/import/
â”‚   â””â”€â”€ fetch.post.ts              # å¯¼å…¥ API ç«¯ç‚¹
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ import-adapters/
â”‚   â”‚   â”œâ”€â”€ index.ts               # é€‚é…å™¨æ³¨å†Œä¸è·¯ç”±
â”‚   â”‚   â”œâ”€â”€ base.ts                # é€šç”¨é€‚é…å™¨ï¼ˆReadability å…œåº•ï¼‰
â”‚   â”‚   â”œâ”€â”€ csdn.ts                # CSDN é€‚é…å™¨
â”‚   â”‚   â”œâ”€â”€ juejin.ts              # æ˜é‡‘é€‚é…å™¨
â”‚   â”‚   â”œâ”€â”€ zhihu.ts               # çŸ¥ä¹ä¸“æ é€‚é…å™¨
â”‚   â”‚   â”œâ”€â”€ cnblogs.ts             # åšå®¢å›­é€‚é…å™¨
â”‚   â”‚   â””â”€â”€ medium.ts              # Medium é€‚é…å™¨
â”‚   â””â”€â”€ import-utils.ts            # å›¾ç‰‡ä¸‹è½½/ä¸Šä¼ ã€URL éªŒè¯ç­‰å·¥å…·å‡½æ•°

composables/
â””â”€â”€ useImport.ts                   # å‰ç«¯å¯¼å…¥é€»è¾‘

pages/
â””â”€â”€ admin/
    â””â”€â”€ import.vue                 # å¯¼å…¥é¡µé¢

components/
â””â”€â”€ ImportPreview.vue              # å¯¼å…¥é¢„è§ˆç»„ä»¶ï¼ˆå¯é€‰ï¼Œä¹Ÿå¯å†…è”åœ¨é¡µé¢ä¸­ï¼‰
```

## ç”¨æˆ·æ“ä½œæµç¨‹

```
1. ç”¨æˆ·è¿›å…¥ã€Œç®¡ç†åå° â†’ å¯¼å…¥æ–‡ç« ã€é¡µé¢
                â”‚
2. ç²˜è´´ç›®æ ‡åšå®¢æ–‡ç« çš„ URL
                â”‚
3. ç‚¹å‡»ã€Œè§£æã€æŒ‰é’®
                â”‚
4. ç­‰å¾… 3-10 ç§’ï¼ˆæ˜¾ç¤ºåŠ è½½åŠ¨ç”»ï¼‰
   â”œâ”€â”€ æœåŠ¡ç«¯æŠ“å–é¡µé¢ HTML
   â”œâ”€â”€ æå–æ­£æ–‡å’Œå…ƒæ•°æ®
   â”œâ”€â”€ ä¸‹è½½å¹¶ä¸Šä¼ å›¾ç‰‡
   â””â”€â”€ è½¬æ¢ä¸º Markdown
                â”‚
5. å±•ç¤ºè§£æç»“æœé¢„è§ˆ
   â”œâ”€â”€ æ ‡é¢˜ã€æ­£æ–‡ã€å›¾ç‰‡ã€æ ‡ç­¾ç­‰
   â”œâ”€â”€ å›¾ç‰‡å¯¼å…¥çŠ¶æ€ï¼ˆæˆåŠŸ/å¤±è´¥æ•°é‡ï¼‰
   â””â”€â”€ æ¥æºæ ‡æ³¨ï¼ˆè‡ªåŠ¨è¿½åŠ åŸæ–‡é“¾æ¥ï¼‰
                â”‚
6. ç”¨æˆ·å¯ä¿®æ”¹æ ‡é¢˜ã€åˆ†ç±»ã€æ ‡ç­¾ã€æ‘˜è¦ç­‰å…ƒæ•°æ®
                â”‚
7. é€‰æ‹©ã€Œä¿å­˜ä¸ºè‰ç¨¿ã€æˆ–ã€Œåœ¨ç¼–è¾‘å™¨ä¸­ç¼–è¾‘ã€
                â”‚
8. æ–‡ç« ä¿å­˜åˆ° Supabase æ•°æ®åº“ï¼Œå›¾ç‰‡ä¿å­˜åˆ° Supabase Storage
                â”‚
9. è·³è½¬åˆ°æ–‡ç« è¯¦æƒ…é¡µæˆ–ç¼–è¾‘å™¨ç»§ç»­ç¼–è¾‘
```

## å®ç°ä¼˜å…ˆçº§

### P0 â€” MVPï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰

- [x] æœåŠ¡ç«¯å†…å®¹æŠ“å– APIï¼ˆ`/api/import/fetch`ï¼‰
- [x] é€šç”¨ Readability æ­£æ–‡æå–ï¼ˆ`base.ts` é€‚é…å™¨ï¼‰
- [x] HTML â†’ Markdown è½¬æ¢ï¼ˆTurndown + ä»£ç å—ä¼˜åŒ–ï¼‰
- [x] å›¾ç‰‡ä¸‹è½½ä¸ä¸Šä¼ åˆ° Supabase Storage
- [x] å›¾ç‰‡ URL æ›¿æ¢
- [x] å‰ç«¯å¯¼å…¥é¡µé¢ï¼ˆURL è¾“å…¥ + é¢„è§ˆ + ä¿å­˜ï¼‰
- [x] æ¥æºæ ‡æ³¨
- [x] å®‰å…¨é˜²æŠ¤ï¼ˆXSSã€SSRFã€é¢‘ç‡é™åˆ¶ï¼‰

### P1 â€” å¹³å°å¢å¼º

- [ ] CSDN ä¸“ç”¨é€‚é…å™¨
- [ ] æ˜é‡‘ä¸“ç”¨é€‚é…å™¨ï¼ˆAPI ç›´æ¥è·å– Markdown åŸæ–‡ï¼‰
- [ ] çŸ¥ä¹ä¸“æ é€‚é…å™¨
- [ ] åšå®¢å›­é€‚é…å™¨
- [ ] Medium é€‚é…å™¨

### P2 â€” ä½“éªŒä¼˜åŒ–

- [ ] å¯¼å…¥è¿›åº¦å®æ—¶æ˜¾ç¤ºï¼ˆå›¾ç‰‡ä¸‹è½½è¿›åº¦ï¼‰
- [ ] å¯¼å…¥å†å²è®°å½•
- [ ] æ‰¹é‡å¯¼å…¥ï¼ˆè¾“å…¥å¤šä¸ª URLï¼‰
- [ ] å¯¼å…¥å¤±è´¥é‡è¯•æœºåˆ¶
- [ ] æ›´ä¸°å¯Œçš„ Turndown è§„åˆ™ï¼ˆè¡¨æ ¼ã€å…¬å¼ç­‰ï¼‰

### P3 â€” é«˜çº§åŠŸèƒ½

- [ ] æµè§ˆå™¨æ‰©å±•ä¸€é”®å¯¼å…¥
- [ ] RSS è®¢é˜…è‡ªåŠ¨å¯¼å…¥
- [ ] æ•´ç«™æ‰¹é‡å¯¼å…¥ï¼ˆè¾“å…¥åšå®¢ä¸»é¡µ URLï¼Œå¯¼å…¥æ‰€æœ‰æ–‡ç« ï¼‰
- [ ] AI è‡ªåŠ¨åˆ†ç±»å’Œæ‰“æ ‡ç­¾

## æµ‹è¯•è®¡åˆ’

### åŠŸèƒ½æµ‹è¯•

| æµ‹è¯•é¡¹        | æµ‹è¯•å†…å®¹                                              |
| ------------- | ----------------------------------------------------- |
| URL éªŒè¯      | éæ³• URLã€å†…ç½‘åœ°å€ã€æ— æ•ˆåè®®                          |
| å†…å®¹æå–      | æ ‡é¢˜ã€æ­£æ–‡ã€ä»£ç å—ã€å›¾ç‰‡ã€å…ƒæ•°æ®                      |
| å›¾ç‰‡å¤„ç†      | æ­£å¸¸ä¸‹è½½ã€é˜²ç›—é“¾ã€è¶…å¤§å›¾ç‰‡ã€æ ¼å¼ä¸æ”¯æŒ                |
| Markdown è½¬æ¢ | æ ‡é¢˜å±‚çº§ã€åˆ—è¡¨ã€ä»£ç å—ï¼ˆå«è¯­è¨€æ ‡è¯†ï¼‰ã€é“¾æ¥ã€åŠ ç²—/æ–œä½“ |
| å¹³å°é€‚é…      | CSDNã€æ˜é‡‘ã€çŸ¥ä¹ã€Mediumã€åšå®¢å›­ã€é€šç”¨ç½‘ç«™            |
| ä¿å­˜åŠŸèƒ½      | è‰ç¨¿ä¿å­˜ã€å…ƒæ•°æ®ä¿å­˜ã€å›¾ç‰‡ URL æ­£ç¡®æ€§                 |

### å®‰å…¨æµ‹è¯•

| æµ‹è¯•é¡¹   | æµ‹è¯•å†…å®¹                     |
| -------- | ---------------------------- |
| XSS      | å¯¼å…¥å« `<script>` æ ‡ç­¾çš„é¡µé¢ |
| SSRF     | å°è¯•æŠ“å– localhostã€å†…ç½‘ IP  |
| å¤§æ–‡ä»¶   | è¶…è¿‡é™åˆ¶çš„æ–‡ç« å’Œå›¾ç‰‡         |
| é¢‘ç‡é™åˆ¶ | çŸ­æ—¶é—´å†…å¤§é‡å¯¼å…¥è¯·æ±‚         |

### å…¼å®¹æ€§æµ‹è¯• URL ç¤ºä¾‹

```
https://blog.csdn.net/xxx/article/details/xxx
https://juejin.cn/post/xxx
https://zhuanlan.zhihu.com/p/xxx
https://medium.com/@xxx/xxx
https://www.cnblogs.com/xxx/p/xxx.html
https://www.jianshu.com/p/xxx
https://dev.to/xxx/xxx
https://xxx.wordpress.com/2024/01/01/xxx
```
